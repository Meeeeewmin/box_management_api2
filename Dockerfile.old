FROM python:3.11-slim

WORKDIR /app

# 시스템 패키지 업데이트 및 필수 패키지 설치
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    nginx \
    supervisor \
    mariadb-server \
    mariadb-client \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성 설치
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 애플리케이션 코드 복사
COPY main.py .
COPY index.html /usr/share/nginx/html/

# Nginx 설정 복사
COPY nginx.conf /etc/nginx/sites-available/default

# MariaDB 초기 설정 스크립트 생성
RUN echo "#!/bin/bash\n\
set -e\n\
\n\
# MariaDB 데이터 디렉토리 초기화 (첫 실행시에만)\n\
if [ ! -d \"/var/lib/mysql/mysql\" ]; then\n\
    echo \"Initializing MariaDB...\"\n\
    mysql_install_db --user=mysql --datadir=/var/lib/mysql\n\
    \n\
    # MariaDB 임시 시작\n\
    mysqld_safe --datadir=/var/lib/mysql &\n\
    MYSQL_PID=\$!\n\
    \n\
    # MariaDB 시작 대기\n\
    for i in {30..0}; do\n\
        if mysqladmin ping &>/dev/null; then\n\
            break\n\
        fi\n\
        sleep 1\n\
    done\n\
    \n\
    # 데이터베이스 및 사용자 생성 (mysql_native_password 플러그인 사용)\n\
    mysql -e \"CREATE DATABASE IF NOT EXISTS iot_box_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\"\n\
    mysql -e \"CREATE USER IF NOT EXISTS 'iot_user'@'localhost' IDENTIFIED VIA mysql_native_password USING PASSWORD('iot_password');\"\n\
    mysql -e \"GRANT ALL PRIVILEGES ON iot_box_db.* TO 'iot_user'@'localhost';\"\n\
    mysql -e \"FLUSH PRIVILEGES;\"\n\
    \n\
    # 임시 MariaDB 종료\n\
    mysqladmin shutdown\n\
    wait \$MYSQL_PID\n\
    \n\
    echo \"MariaDB initialization completed\"\n\
fi\n\
\n\
# Supervisor 실행\n\
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf" > /app/entrypoint.sh

RUN chmod +x /app/entrypoint.sh

# Supervisor 설정 생성
RUN echo "[supervisord]\n\
nodaemon=true\n\
user=root\n\
\n\
[program:mariadb]\n\
command=/usr/sbin/mysqld --user=mysql\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
priority=1\n\
startsecs=10\n\
\n\
[program:api]\n\
command=/usr/local/bin/uvicorn main:app --host 127.0.0.1 --port 8000\n\
directory=/app\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
priority=2\n\
startsecs=15\n\
\n\
[program:nginx]\n\
command=/usr/sbin/nginx -g 'daemon off;'\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
priority=3\n\
startsecs=5" > /etc/supervisor/conf.d/supervisord.conf

# MariaDB 데이터 디렉토리 생성 및 권한 설정
RUN mkdir -p /var/lib/mysql /var/run/mysqld \
    && chown -R mysql:mysql /var/lib/mysql /var/run/mysqld \
    && chmod 777 /var/run/mysqld

# 볼륨 (데이터 영속성)
VOLUME ["/var/lib/mysql"]

# 포트 노출
EXPOSE 40001

# Entrypoint 실행
ENTRYPOINT ["/app/entrypoint.sh"]
